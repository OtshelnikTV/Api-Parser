<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Doc Parser</title>
    <style>
:root {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-tertiary: #1c2128;
  --bg-hover: #22272e;
  --bg-input: #0d1117;
  --border-primary: #30363d;
  --border-hover: #484f58;
  --text-primary: #c9d1d9;
  --text-secondary: #8b949e;
  --text-tertiary: #484f58;
  --accent-blue: #58a6ff;
  --accent-green: #3fb950;
  --accent-yellow: #d29922;
  --accent-red: #f85149;
  --accent-purple: #bc8cff;
}

[data-theme="light-pink"] {
  --bg-primary: #fff5f7;
  --bg-secondary: #ffe4e9;
  --bg-tertiary: #ffd4de;
  --bg-hover: #ffc4d0;
  --bg-input: #fff;
  --border-primary: #ffb3c6;
  --border-hover: #ff8fa8;
  --text-primary: #5c2e3e;
  --text-secondary: #8b5a6b;
  --text-tertiary: #b08997;
  --accent-blue: #d35d8e;
  --accent-green: #c95d8e;
  --accent-yellow: #e89bb8;
  --accent-red: #ff6b9d;
  --accent-purple: #e89dd4;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: background-color 0.3s, color 0.3s;
}

body {
  overflow: hidden;
}

.hidden {
  display: none !important;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
  background: var(--border-primary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

.nested-dto {
  border-left: 2px solid var(--border-primary);
  margin: 8px 0 8px 16px;
  padding-left: 12px;
}

.nested-dto-header {
  color: var(--accent-purple);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: 600;
}

.nested-dto-header:hover {
  opacity: 0.8;
}

.nested-dto-badge {
  color: var(--accent-purple);
  background: rgba(188, 140, 255, 0.2);
  border-radius: 4px;
  margin-left: 6px;
  padding: 2px 7px;
  font-size: 10px;
  font-weight: 600;
}

.app-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  padding-left: 80px;
}

.theme-toggle {
  position: fixed;
  top: 20px;
  left: 20px;
  width: 48px;
  height: 48px;
  border: 2px solid var(--border-primary);
  background: var(--bg-secondary);
  color: var(--text-primary);
  cursor: pointer;
  z-index: 999;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.theme-toggle:hover {
  border-color: var(--accent-blue);
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.theme-toggle:active {
  transform: scale(0.95);
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(13, 17, 23, 0.9);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

.loading-spinner {
  border: 3px solid var(--border-primary);
  border-top: 3px solid var(--accent-blue);
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--text-secondary);
  font-size: 14px;
}

.loading-progress {
  color: var(--accent-blue);
  margin-top: 8px;
  font-family: monospace;
  font-size: 13px;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 16px;
  padding: 32px;
  width: 92%;
  max-width: 620px;
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
}

.modal h2 {
  color: var(--accent-blue);
  font-size: 22px;
  margin-bottom: 8px;
}

.modal p {
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 20px;
}

.modal code {
  background: var(--bg-tertiary);
  padding: 2px 6px;
  border-radius: 4px;
  color: var(--accent-blue);
  font-family: monospace;
  font-size: 12px;
}

.step-indicator {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.step-dot {
  width: 32px;
  height: 4px;
  background: var(--border-primary);
  border-radius: 2px;
}

.step-dot.active {
  background: var(--accent-blue);
}

.step-dot.done {
  background: var(--accent-green);
}

.modal-icon {
  display: block;
  font-size: 48px;
  text-align: center;
  margin-bottom: 16px;
}

.project-list {
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  max-height: 250px;
  overflow-y: auto;
}

.project-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--bg-tertiary);
  cursor: pointer;
  transition: all 0.15s;
}

.project-item:last-child {
  border-bottom: none;
}

.project-item:hover {
  background: rgba(88, 166, 255, 0.08);
}

.project-item.selected {
  border-left: 4px solid var(--accent-green);
  background: rgba(63, 185, 80, 0.12);
}

.project-item-icon {
  flex-shrink: 0;
  font-size: 24px;
}

.project-item-content {
  flex: 1;
}

.project-item-name {
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 2px;
}

.project-item-info {
  color: var(--text-secondary);
  font-size: 12px;
}

.search-input {
  background: var(--bg-input);
  border: 1px solid var(--border-primary);
  width: 100%;
  color: var(--text-primary);
  border-radius: 8px;
  margin-bottom: 10px;
  padding: 10px 14px;
  font-size: 14px;
  transition: border-color 0.2s;
}

.search-input:focus {
  border-color: var(--accent-blue);
  outline: none;
}

.search-input::placeholder {
  color: var(--text-tertiary);
}

.request-list {
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  max-height: 350px;
  margin-bottom: 16px;
  overflow-y: auto;
}

.request-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--bg-tertiary);
  cursor: pointer;
  transition: background 0.15s;
}

.request-item:last-child {
  border-bottom: none;
}

.request-item:hover {
  background: rgba(88, 166, 255, 0.08);
}

.request-item.selected {
  border-left: 3px solid var(--accent-green);
  background: rgba(63, 185, 80, 0.12);
}

.request-item-name {
  flex: 1;
  color: var(--text-primary);
  font-family: monospace;
  font-size: 13px;
}

.request-item-methods {
  display: flex;
  gap: 4px;
}

.method-tag {
  text-transform: uppercase;
  border-radius: 4px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 10px;
  font-weight: 700;
}

.method-tag-get {
  color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.15);
}

.method-tag-post {
  color: var(--accent-green);
  background: rgba(63, 185, 80, 0.15);
}

.method-tag-put {
  color: var(--accent-yellow);
  background: rgba(210, 153, 34, 0.15);
}

.method-tag-delete {
  color: var(--accent-red);
  background: rgba(248, 81, 73, 0.15);
}

.method-tag-patch {
  color: var(--accent-purple);
  background: rgba(188, 140, 255, 0.15);
}

#method-selector {
  display: flex;
  gap: 12px;
}

.method-btn {
  padding: 10px 20px;
  border: 1px solid var(--border-primary);
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  font-size: 14px;
}

.method-btn:hover {
  background: var(--bg-hover);
  border-color: var(--accent-blue);
}

.method-btn-get { border-color: var(--accent-green); }
.method-btn-get.selected {
  background: rgba(63, 185, 80, 0.15);
  border-color: var(--accent-green);
  color: var(--accent-green);
}

.method-btn-post { border-color: var(--accent-blue); }
.method-btn-post.selected {
  background: rgba(88, 166, 255, 0.15);
  border-color: var(--accent-blue);
  color: var(--accent-blue);
}

.method-btn-put { border-color: var(--accent-yellow); }
.method-btn-put.selected {
  background: rgba(210, 153, 34, 0.15);
  border-color: var(--accent-yellow);
  color: var(--accent-yellow);
}

.method-btn-delete { border-color: var(--accent-red); }
.method-btn-delete.selected {
  background: rgba(248, 81, 73, 0.15);
  border-color: var(--accent-red);
  color: var(--accent-red);
}

.method-btn-patch { border-color: var(--accent-purple); }
.method-btn-patch.selected {
  background: rgba(188, 140, 255, 0.15);
  border-color: var(--accent-purple);
  color: var(--accent-purple);
}

.btn {
  border: 1px solid var(--border-primary);
  background: var(--bg-tertiary);
  color: var(--text-primary);
  cursor: pointer;
  white-space: nowrap;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  font-size: 13px;
  transition: all 0.2s;
}

.btn:hover:not(:disabled) {
  background: var(--bg-hover);
  border-color: var(--border-hover);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}

.btn-primary:hover:not(:disabled) {
  opacity: 0.9;
}

.btn-blue {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
}

.btn-lg {
  padding: 12px 24px;
  font-size: 15px;
}

.app-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
}

.header {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 24px;
  padding: 16px 24px;
  position: relative;
}

.header h1 {
  color: var(--accent-blue);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 20px;
}

.header-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.status-bar {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding: 10px 16px;
  font-size: 13px;
}

.status-dot {
  background: var(--accent-green);
  flex-shrink: 0;
  border-radius: 50%;
  width: 8px;
  height: 8px;
}

.status-path {
  color: var(--text-secondary);
  flex: 1;
  font-family: monospace;
  font-size: 12px;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.legend {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 20px;
  padding: 12px 16px;
  font-size: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text-secondary);
}

.legend-color {
  border-radius: 3px;
  width: 12px;
  height: 12px;
}

.legend-color.auto {
  background: rgba(63, 185, 80, 0.3);
  border: 1px solid var(--accent-green);
}

.legend-color.manual {
  background: rgba(210, 153, 34, 0.3);
  border: 1px solid var(--accent-yellow);
}

.legend-color.required {
  background: rgba(248, 81, 73, 0.3);
  border: 1px solid var(--accent-red);
  animation: pulse-badge 2s ease-in-out infinite;
}

@keyframes pulse-badge {
  0%, to { opacity: 1; }
  50% { opacity: 0.6; }
}

#editor-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.template-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  margin-bottom: 20px;
  overflow: hidden;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-primary);
  cursor: pointer;
  user-select: none;
}

.section-header:hover {
  background: var(--bg-hover);
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
  font-weight: 600;
}

.section-badge {
  border-radius: 10px;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: 600;
}

.badge-auto {
  background: rgba(63, 185, 80, 0.15);
  color: var(--accent-green);
}

.badge-manual {
  background: rgba(210, 153, 34, 0.15);
  color: var(--accent-yellow);
}

.badge-required {
  background: rgba(248, 81, 73, 0.15);
  color: var(--accent-red);
  animation: pulse-badge 2s ease-in-out infinite;
}

.section-chevron {
  color: var(--text-secondary);
  font-size: 12px;
  transition: transform 0.2s;
}

.section-header.collapsed .section-chevron {
  transform: rotate(-90deg);
}

.section-body {
  padding: 20px;
}

.section-body.collapsed-body {
  display: none;
}

.kv-grid {
  background: var(--border-primary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  display: grid;
  grid-template-columns: 160px 1fr;
  gap: 1px;
  overflow: hidden;
}

.kv-label {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
}

.kv-value {
  background: var(--bg-secondary);
  padding: 4px;
}

.kv-value .cell-input {
  border: none;
  min-height: 36px;
  padding: 6px 10px;
}

.cell-input {
  width: 100%;
  min-height: 32px;
  color: var(--text-primary);
  resize: vertical;
  background: transparent;
  border: 1px solid transparent;
  border-radius: 4px;
  padding: 6px 10px;
  font-family: Cascadia Code, Fira Code, Consolas, monospace;
  font-size: 13px;
  transition: border-color 0.2s;
}

.cell-input:focus {
  border-color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.05);
  outline: none;
}

.cell-input.auto-filled {
  color: var(--accent-green);
}

.cell-static {
  color: var(--accent-green);
  padding: 6px 10px;
  font-family: Cascadia Code, Fira Code, Consolas, monospace;
  font-size: 13px;
  display: block;
}

.table-wrapper {
  margin: 12px 0;
  overflow-x: auto;
}

.edit-table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

.edit-table th {
  background: var(--bg-tertiary);
  text-align: left;
  color: var(--text-secondary);
  border: 1px solid var(--border-primary);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 10px 14px;
  font-size: 12px;
  font-weight: 600;
}

.edit-table td {
  border: 1px solid var(--border-primary);
  vertical-align: top;
  padding: 6px 8px;
}

.edit-table tr:hover {
  background: rgba(88, 166, 255, 0.05);
}

.edit-table tr.nested-field {
  background: rgba(188, 140, 255, 0.03);
}

.edit-table tr.nested-field:hover {
  background: rgba(188, 140, 255, 0.08);
}

.edit-table tr.nested-field td {
  border-left-color: rgba(188, 140, 255, 0.3);
}

.cell-auto {
  background: rgba(63, 185, 80, 0.08);
}

.cell-manual {
  background: rgba(210, 153, 34, 0.08);
  position: relative;
}

.cell-manual:before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 3px;
  height: 100%;
  background: var(--accent-yellow);
}

.cell-required {
  background: rgba(248, 81, 73, 0.08);
  position: relative;
}

.cell-required:before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 3px;
  height: 100%;
  background: var(--accent-red);
  animation: pulse-border 2s ease-in-out infinite;
}

@keyframes pulse-border {
  0%, to { opacity: 1; }
  50% { opacity: 0.3; }
}

.indent-marker {
  color: var(--text-tertiary);
  user-select: none;
  margin-right: 4px;
  font-size: 13px;
  font-weight: 600;
}

.field-name-wrapper {
  display: flex;
  align-items: center;
}

.nested-field {
  background: rgba(188, 140, 255, 0.05);
}

.array-badge {
  color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.15);
  border-radius: 3px;
  margin-left: 4px;
  padding: 1px 5px;
  font-size: 10px;
  font-weight: 600;
}

.method-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.method-get {
  color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.15);
}

.method-post {
  color: var(--accent-green);
  background: rgba(63, 185, 80, 0.15);
}

.method-put {
  color: var(--accent-yellow);
  background: rgba(210, 153, 34, 0.15);
}

.method-delete {
  color: var(--accent-red);
  background: rgba(248, 81, 73, 0.15);
}

.method-patch {
  color: var(--accent-purple);
  background: rgba(188, 140, 255, 0.15);
}

.block-editor {
  background: var(--bg-input);
  border: 1px solid var(--border-primary);
  width: 100%;
  min-height: 120px;
  color: var(--text-primary);
  resize: vertical;
  border-radius: 8px;
  padding: 14px;
  font-family: Cascadia Code, Fira Code, Consolas, monospace;
  font-size: 13px;
  line-height: 1.6;
  transition: border-color 0.2s;
}

.block-editor:focus {
  border-color: var(--accent-blue);
  outline: none;
  box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
}

.block-editor.highlight-manual {
  border-color: var(--accent-yellow);
  box-shadow: 0 0 0 3px rgba(210, 153, 34, 0.1);
}

.block-editor.highlight-required {
  border-color: var(--accent-red);
  animation: pulse-shadow 2s ease-in-out infinite;
  box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.1);
}

@keyframes pulse-shadow {
  0%, to { box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.1); }
  50% { box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.3); }
}

.mermaid-editor-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 12px;
}

.mermaid-editor-panel {
  display: flex;
  flex-direction: column;
}

.mermaid-panel-header {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  color: var(--text-secondary);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 600;
}

.mermaid-panel-header .icon {
  font-size: 14px;
}

.mermaid-code-editor {
  background: var(--bg-input);
  min-height: 400px;
  color: var(--text-primary);
  border: 1px solid var(--border-primary);
  resize: vertical;
  border-radius: 0 0 8px 8px;
  flex: 1;
  padding: 16px;
  font-family: Consolas, Monaco, Courier New, monospace;
  font-size: 13px;
  line-height: 1.6;
  transition: border-color 0.2s;
}

.mermaid-code-editor:focus {
  border-color: var(--accent-blue);
  outline: none;
  box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
}

.mermaid-preview-container {
  background: var(--bg-input);
  border: 1px solid var(--border-primary);
  border-radius: 0 0 8px 8px;
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 400px;
  padding: 24px;
  overflow: auto;
}

.mermaid-preview-content {
  width: 100%;
  max-width: 100%;
}

.mermaid-preview-error {
  color: var(--accent-red);
  background: rgba(248, 81, 73, 0.1);
  border-radius: 8px;
  padding: 16px;
  font-size: 13px;
  line-height: 1.6;
}

.mermaid-preview-empty {
  color: var(--text-tertiary);
  font-size: 14px;
  text-align: center;
  font-style: italic;
}

.dep-card {
  background: var(--bg-input);
  border: 1px solid var(--border-primary);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
}

.dep-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.dep-card-title {
  color: var(--accent-blue);
  font-size: 14px;
  font-weight: 600;
}

.dep-remove-btn {
  color: var(--accent-red);
  cursor: pointer;
  background: transparent;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 16px;
}

.dep-remove-btn:hover {
  background: rgba(248, 81, 73, 0.1);
}

.add-row-btn {
  border: 1px dashed var(--border-primary);
  width: 100%;
  color: var(--text-secondary);
  cursor: pointer;
  background: transparent;
  border-radius: 6px;
  margin-top: 8px;
  padding: 8px;
  font-size: 13px;
  transition: all 0.2s;
}

.add-row-btn:hover {
  border-color: var(--accent-blue);
  color: var(--accent-blue);
  background: rgba(88, 166, 255, 0.05);
}

.delete-row-btn {
  color: var(--accent-red);
  cursor: pointer;
  opacity: 0.5;
  background: transparent;
  border: none;
  border-radius: 4px;
  padding: 4px;
  font-size: 14px;
  transition: opacity 0.2s;
}

.delete-row-btn:hover {
  opacity: 1;
  background: rgba(248, 81, 73, 0.1);
}

.response-group {
  margin-bottom: 12px;
}

.response-code {
  display: inline-block;
  border-radius: 4px;
  margin-right: 8px;
  padding: 2px 8px;
  font-family: monospace;
  font-size: 13px;
  font-weight: 700;
}

.response-2xx {
  color: var(--accent-green);
  background: rgba(63, 185, 80, 0.15);
}

.response-4xx {
  color: var(--accent-yellow);
  background: rgba(210, 153, 34, 0.15);
}

.response-5xx {
  color: var(--accent-red);
  background: rgba(248, 81, 73, 0.15);
}

.info-note {
  color: var(--text-secondary);
  background: rgba(88, 166, 255, 0.08);
  border: 1px solid rgba(88, 166, 255, 0.2);
  border-radius: 8px;
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 12px;
  padding: 12px 16px;
  font-size: 13px;
}

.info-note-icon {
  color: var(--accent-blue);
  flex-shrink: 0;
  font-size: 16px;
}

.generate-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 12px 12px 0 0;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: 24px;
  padding: 16px 24px;
  position: sticky;
  bottom: 0;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.generate-info {
  color: var(--text-secondary);
  font-size: 13px;
}

.generate-info span {
  color: var(--accent-red);
  font-weight: 600;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  max-width: 400px;
  padding: 12px 20px;
  font-size: 14px;
  border-radius: 8px;
  animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
  z-index: 2000;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.notification.success {
  background: var(--accent-green);
  color: #fff;
  border: 1px solid var(--accent-green);
}

.notification.error {
  background: var(--accent-red);
  color: #fff;
  border: 1px solid var(--accent-red);
}

.notification.info {
  background: var(--accent-blue);
  color: #fff;
  border: 1px solid var(--accent-blue);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes fadeOut {
  to {
    opacity: 0;
    transform: translateY(-20px);
  }
}
    </style>
</head>
<body>


<!-- Theme Toggle Button -->
<button id="theme-toggle" class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üå∏</button>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div id="loading-text" class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="loading-progress" class="loading-progress"></div>
</div>

<!-- STEP 1: Project Selection -->
<div id="setup-project" class="modal-overlay">
    <div class="modal">
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
        </div>
        <span class="modal-icon">üìÅ</span>
        <h2>–í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ IntelliJ IDEA –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏</p>
        <div class="project-list" id="project-list"></div>
        <div style="display:flex;gap:12px;margin-top:24px;">
            <button id="btn-save-project" class="btn btn-primary btn-lg" style="flex:1;" disabled>
                –î–∞–ª–µ–µ
            </button>
        </div>
    </div>
</div>

<!-- STEP 2: Request Selection -->
<div id="setup-request" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px;">
        <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
        </div>
        <span class="modal-icon">üîç</span>
        <h2>–í—ã–±–æ—Ä —ç–Ω–ø–æ–∏–Ω—Ç–∞</h2>
        <p>–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π API —ç–Ω–ø–æ–∏–Ω—Ç</p>
        <input type="text" id="request-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ —ç–Ω–ø–æ–∏–Ω—Ç–∞...">
        <div class="request-list" id="request-list"></div>
        <div style="display:flex;gap:12px;margin-top:24px;">
            <button id="btn-back-to-project" class="btn btn-lg" style="flex:1;">‚Üê –ù–∞–∑–∞–¥</button>
            <button id="btn-next-method" class="btn btn-primary btn-lg" style="flex:1;" disabled>–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </div>
</div>

<!-- STEP 3: Method Selection -->
<div id="setup-method" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
        <span class="modal-icon">üìã</span>
        <h2>–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞</h2>
        <p id="selected-endpoint-name"></p>
        <div id="method-selector" style="margin-bottom:24px;"></div>
        <div style="display:flex;gap:12px;">
            <button id="btn-back-to-requests" class="btn btn-lg" style="flex:1;">‚Üê –ù–∞–∑–∞–¥</button>
            <button id="btn-parse" class="btn btn-primary btn-lg" style="flex:1;" disabled>–ü–∞—Ä—Å–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- EDITOR -->
<div id="main-editor" class="app-container hidden">
    <div class="header">
        <h1>üìã API Doc Parser</h1>
        <div class="header-actions">
            <button class="btn" id="btn-editor-back-to-requests">‚Üê –ó–∞–ø—Ä–æ—Å</button>
            <button class="btn" id="btn-editor-back-to-project">‚Üê –ü—Ä–æ–µ–∫—Ç</button>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-dot"></div>
        <span id="status-text">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</span>
        <span class="status-path" id="status-path"></span>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color auto"></div>
            <span>–ê–≤—Ç–æ (–∏–∑ YAML)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color manual"></div>
            <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</span>
        </div>
        <div class="legend-item">
            <div class="legend-color required"></div>
            <span>–ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é</span>
        </div>
    </div>
    
    <div id="editor-content"></div>
    
    <div class="generate-panel">
        <div class="generate-info">
            –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö: <span id="unfilled-count">0</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-blue btn-lg" id="btn-preview-markdown">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button class="btn btn-primary btn-lg" id="btn-generate-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div id="preview-modal" class="modal-overlay hidden" style="align-items:stretch;">
    <div style="background:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:16px;margin:24px;flex:1;display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:16px 24px;border-bottom:1px solid var(--border-primary);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
            <h2 style="color:var(--accent-blue);font-size:18px;">üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-primary" id="btn-preview-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" id="btn-close-preview">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div style="flex:1;overflow:auto;padding:24px;">
            <pre id="preview-content" style="font-family:'Cascadia Code','Fira Code','Consolas',monospace;font-size:13px;line-height:1.5;white-space:pre-wrap;color:var(--text-primary);"></pre>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
            darkMode: true,
            background: '#0d1117',
            primaryColor: '#58a6ff',
            primaryTextColor: '#c9d1d9',
            primaryBorderColor: '#30363d',
            lineColor: '#8b949e',
            secondaryColor: '#21262d',
            tertiaryColor: '#161b22'
        }
    });
</script>
<script>
// Global variables
let selectedProject = null;
let selectedEndpoint = null;
let selectedEndpointFilePath = null;
let selectedMethod = null;
let currentData = null;
let endpoints = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Application started');
    
    // Load saved theme
    const savedTheme = localStorage.getItem('app-theme');
    if (savedTheme === 'light-pink') {
        document.documentElement.setAttribute('data-theme', 'light-pink');
        document.getElementById('theme-toggle').textContent = 'üåô';
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Load projects
    loadProjects();
});

function displayProjects(projects) {
    const container = document.getElementById('project-list');
    if (!container) {
        console.error('project-list element not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (projects.length === 0) {
        container.innerHTML = '<div>No projects found</div>';
        return;
    }
    
    projects.forEach(project => {
        const item = document.createElement('div');
        item.className = 'project-item';
        item.dataset.projectName = project.name;
        item.innerHTML = `
            <div class="project-name">${escapeHtml(project.name)}</div>
            <div class="project-path">${escapeHtml(project.rootPath)}</div>
        `;
        item.onclick = () => selectProject(project);
        container.appendChild(item);
    });
}

function selectProject(project) {
    console.log('Selected project:', project.name);
    
    document.querySelectorAll('.project-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    const selectedItem = document.querySelector(`[data-project-name="${project.name}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
    
    selectedProject = project;
    document.getElementById('btn-save-project').disabled = false;
}

async function loadProjects() {
    try {
        console.log('Loading projects...');
        const response = await fetch('/api/projects');
        const projects = await response.json();
        console.log('Projects loaded:', projects);
        displayProjects(projects);
    } catch (error) {
        console.error('Error loading projects:', error);
        document.getElementById('project-list').innerHTML = '<div style="color:red;">Error loading projects: ' + error.message + '</div>';
    }
}

function setupEventListeners() {
    // Project selection
    document.getElementById('btn-save-project').addEventListener('click', () => {
        if (selectedProject) {
            showRequestSelector();
        }
    });
    
    // Back to project
    document.getElementById('btn-back-to-project').addEventListener('click', () => {
        showProjectSelector();
    });
    
    // Request search
    document.getElementById('request-search').addEventListener('input', (e) => {
        displayEndpoints(e.target.value);
    });
    
    // Next to method
    document.getElementById('btn-next-method').addEventListener('click', () => {
        if (selectedEndpoint) {
            showMethodSelector();
        }
    });
    
    // Back to requests
    document.getElementById('btn-back-to-requests').addEventListener('click', () => {
        showRequestSelector();
    });
    
    // Parse endpoint
    document.getElementById('btn-parse').addEventListener('click', () => {
        if (selectedMethod) {
            parseEndpoint();
        }
    });
    
    // Editor navigation
    document.getElementById('btn-editor-back-to-requests').addEventListener('click', () => {
        selectedMethod = null;
        showRequestSelector();
    });
    
    document.getElementById('btn-editor-back-to-project').addEventListener('click', () => {
        selectedEndpoint = null;
        selectedMethod = null;
        showProjectSelector();
    });
    
    // Preview modal
    document.getElementById('btn-preview-markdown').addEventListener('click', () => {
        showPreviewModal(currentData);
    });

    document.getElementById('btn-generate-save').addEventListener('click', () => {
        if (currentData) {
            saveMarkdownFile(currentData);
        }
    });
    
    document.getElementById('btn-close-preview').addEventListener('click', () => {
        document.getElementById('preview-modal').classList.add('hidden');
    });
    
    document.getElementById('btn-preview-save').addEventListener('click', () => {
        if (currentData) {
            saveMarkdownFile(currentData);
            document.getElementById('preview-modal').classList.add('hidden');
        }
    });
    
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
}

function showProjectSelector() {
    hideAllScreens();
    document.getElementById('setup-project').classList.remove('hidden');
}

function showRequestSelector() {
    hideAllScreens();
    document.getElementById('setup-request').classList.remove('hidden');
    loadEndpoints();
}

function showMethodSelector() {
    hideAllScreens();
    document.getElementById('setup-method').classList.remove('hidden');
    displayMethods();
}

function showEditor() {
    hideAllScreens();
    document.getElementById('main-editor').classList.remove('hidden');
}

function hideAllScreens() {
    document.getElementById('setup-project').classList.add('hidden');
    document.getElementById('setup-request').classList.add('hidden');
    document.getElementById('setup-method').classList.add('hidden');
    document.getElementById('main-editor').classList.add('hidden');
}

async function loadEndpoints() {
    if (!selectedProject) return;
    
    try {
        const response = await fetch(`/api/endpoints?project=${encodeURIComponent(selectedProject.name)}&rootPath=${encodeURIComponent(selectedProject.rootPath)}`);
        endpoints = await response.json();
        console.log('Endpoints loaded:', endpoints);
        displayEndpoints();
    } catch (error) {
        console.error('Error loading endpoints:', error);
    }
}

function displayEndpoints(filter = '') {
    const container = document.getElementById('request-list');
    const filtered = endpoints.filter(ep => 
        ep.apiPath.toLowerCase().includes(filter.toLowerCase())
    );
    
    container.innerHTML = '';
    
    if (filtered.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-tertiary);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    
    filtered.forEach(ep => {
        const item = document.createElement('div');
        item.className = `request-item ${selectedEndpoint === ep.apiPath ? 'selected' : ''}`;
        item.dataset.request = ep.apiPath;
        item.dataset.filePath = ep.filePath;
        
        const methodsHtml = ep.methods.map(m => 
            `<span class="method-tag method-tag-${m}">${m}</span>`
        ).join('');
        
        item.innerHTML = `
            <span class="request-item-name">${escapeHtml(ep.apiPath)}</span>
            <div class="request-item-methods">${methodsHtml}</div>
        `;
        
        item.onclick = () => selectEndpoint(ep.apiPath, ep.filePath);
        container.appendChild(item);
    });
}

function selectEndpoint(apiPath, filePath) {
    console.log('Selected endpoint:', apiPath, 'file:', filePath);
    selectedEndpoint = apiPath;
    selectedEndpointFilePath = filePath;
    
    document.querySelectorAll('.request-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    const selectedItem = document.querySelector(`[data-request="${apiPath}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }
    
    document.getElementById('btn-next-method').disabled = false;
}

function displayMethods() {
    const container = document.getElementById('method-selector');
    const endpoint = endpoints.find(ep => ep.apiPath === selectedEndpoint);
    
    if (!endpoint) return;
    
    document.getElementById('selected-endpoint-name').textContent = selectedEndpoint;
    
    container.innerHTML = '';
    
    endpoint.methods.forEach(method => {
        const button = document.createElement('button');
        button.className = `method-btn method-btn-${method} ${selectedMethod === method ? 'selected' : ''}`;
        button.textContent = method.toUpperCase();
        button.onclick = () => selectMethod(method);
        container.appendChild(button);
    });
}

function selectMethod(method) {
    console.log('Selected method:', method);
    selectedMethod = method;
    
    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    const selectedBtn = Array.from(document.querySelectorAll('.method-btn'))
        .find(btn => btn.textContent === method.toUpperCase());
    if (selectedBtn) {
        selectedBtn.classList.add('selected');
    }
    
    document.getElementById('btn-parse').disabled = false;
}

async function parseEndpoint() {
    if (!selectedProject || !selectedEndpoint || !selectedMethod) return;
    
    try {
        const response = await fetch('/api/parse-endpoint', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                projectRoot: selectedProject.rootPath,
                endpointPath: selectedEndpointFilePath,
                method: selectedMethod
            })
        });
        
        const result = await response.json();
        console.log('Parsed result:', result);
        console.log('Full result object:', JSON.stringify(result, null, 2));
        
        // Set URL from selected endpoint
        result.url = selectedEndpoint;
        
        currentData = result;
        
        showEditor();
        displayParsedData(result);
        updateUnfilledCount(result);
        
    } catch (error) {
        console.error('Error parsing endpoint:', error);
        alert('Error parsing endpoint: ' + error.message);
    }
}

function flattenFields(fields, depth = 0) {
    let result = [];

    if (!fields || !Array.isArray(fields)) {
        return result;
    }

    for (const field of fields) {
        const flatField = {
            ...field,
            depth: field.depth !== undefined ? field.depth : depth
        };

        delete flatField.children;

        result.push(flatField);

        if (field.children && field.children.length > 0) {
            const nested = flattenFields(field.children, depth + 1);
            result = result.concat(nested);
        }
    }

    return result;
}

function renderFieldsTable(fields, showSource = false) {
    if (!fields || fields.length === 0) {
        return '<div style="padding: 24px; text-align: center; color: var(--text-tertiary);">‚ÑπÔ∏è –ü–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    }

    const flatFields = flattenFields(fields);
    
    let headers = '<th>–ü–æ–ª–µ</th><th>–¢–∏–ø</th><th>–û–±—è–∑.</th><th>–§–æ—Ä–º–∞—Ç</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ü—Ä–∏–º–µ—Ä</th>';
    if (showSource) {
        headers += '<th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>';
    }

    let tableHtml = `
        <div class="table-wrapper">
            <table class="edit-table">
                <thead>
                    <tr>${headers}</tr>
                </thead>
                <tbody>
    `;

    flatFields.forEach((field) => {
        const indent = field.depth * 24;
        const isNested = field.depth > 0;
        const rowClass = isNested ? ' nested-field' : '';
        
        let depthMarker = '';
        if (isNested) {
            const markers = [];
            for (let d = 1; d < field.depth; d++) {
                markers.push('‚îÇ&nbsp;&nbsp;');
            }
            markers.push('‚îú‚îÄ');
            depthMarker = '<span class="indent-marker">' + markers.join('') + ' </span>';
        }

        const nameDisplay = `<div style="margin-left:${indent}px">${depthMarker}<code>${escapeHtml(field.name)}</code></div>`;
        const requiredMark = field.required ? '‚úÖ' : '‚ùå';
        
        let sourceCell = '';
        if (showSource) {
            sourceCell = `<td class="cell-required">
                    <input type="text" class="cell-input" placeholder="üì• –ò—Å—Ç–æ—á–Ω–∏–∫" value="">
                </td>`;
        }

        tableHtml += `<tr class="${rowClass}">
                <td class="cell-auto"><span class="cell-static">${nameDisplay}</span></td>
                <td class="cell-auto"><span class="cell-static"><code>${escapeHtml(field.type || '‚Äî')}</code></span></td>
                <td class="cell-auto"><span class="cell-static">${requiredMark}</span></td>
                <td class="cell-auto"><span class="cell-static"><code>${escapeHtml(field.format || '‚Äî')}</code></span></td>
                <td class="${field.description ? 'cell-auto' : 'cell-manual'}">
                    <span class="cell-static">${escapeHtml(field.description || '‚Äî')}</span>
                </td>
                <td class="${field.example ? 'cell-auto' : 'cell-manual'}">
                    <span class="cell-static">${escapeHtml(field.example || '‚Äî')}</span>
                </td>
                ${sourceCell}
            </tr>`;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
    `;

    return tableHtml;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function attachMermaidHandlers() {
    const editor = document.getElementById('mermaid-code-editor');
    const preview = document.getElementById('mermaid-preview');
    
    if (!editor || !preview) return;

    let debounceTimer;
    const updatePreview = async () => {
        const code = editor.value.trim();
        
        if (!code) {
            preview.innerHTML = '<div class="mermaid-preview-empty">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å–ª–µ–≤–∞...</div>';
            return;
        }

        try {
            preview.innerHTML = '';
            const id = 'mermaid-' + Date.now();
            const { svg } = await mermaid.render(id, code);
            preview.innerHTML = `<div class="mermaid-preview-content">${svg}</div>`;
        } catch (error) {
            preview.innerHTML = `<div class="mermaid-preview-error">
                <strong>–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:</strong><br>
                ${escapeHtml(error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º—ã')}
            </div>`;
        }
    };

    editor.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updatePreview, 500);
    });

    await updatePreview();
}

function generateMarkdown(data) {
    let md = `# ${escapeHtml(data.operationId || 'endpoint')} ‚Äî ${escapeHtml(data.summary || '–û–ø–∏—Å–∞–Ω–∏–µ')}\n\n`;

    md += '## 1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n';
    md += `| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |\n`;
    md += `|----------|----------|\n`;
    md += `| **–ú–µ—Ç–æ–¥** | \`${data.method}\` |\n`;
    md += `| **URL** | \`${escapeHtml(data.url)}\` |\n`;
    md += `| **–¢–µ–≥** | \`${escapeHtml(data.tag)}\` |\n`;
    md += `| **Operation** | \`${escapeHtml(data.operationId)}\` |\n`;
    md += `| **–û–ø–∏—Å–∞–Ω–∏–µ** | ${escapeHtml(data.summary)} |\n\n`;
    md += '---\n\n';

    // 2. Request
    if (data.requestFields && data.requestFields.length > 0) {
        md += '## 2. Request\n\n';
        md += `### Request Body\n\n**–°—Ö–µ–º–∞:** \`${escapeHtml(data.requestSchemaName || 'Unknown')}\`\n\n`;
        md += fieldsToMarkdownTable(data.requestFields);
        
        if (data.exampleRequest) {
            try {
                const parsed = JSON.parse(data.exampleRequest);
                md += '\n### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞\n\n```json\n' + JSON.stringify(parsed, null, 2) + '\n```\n\n';
            } catch(e) {
                md += '\n### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞\n\n```\n' + escapeHtml(data.exampleRequest) + '\n```\n\n';
            }
        }
        md += '---\n\n';
    }

    // 3. Response
    if (data.responseFields && data.responseFields.length > 0) {
        md += '## 3. Response\n\n';
        md += '### 3.1 Response Body\n\n**–°—Ö–µ–º–∞:** \`' + escapeHtml(data.responseSchemaName || 'response') + '\`\n\n';
        md += fieldsToMarkdownTable(data.responseFields);
        
        if (data.exampleResponse) {
            try {
                const parsed = JSON.parse(data.exampleResponse);
                md += '\n### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞\n\n```json\n' + JSON.stringify(parsed, null, 2) + '\n```\n\n';
            } catch(e) {
                md += '\n### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞\n\n```\n' + escapeHtml(data.exampleResponse) + '\n```\n\n';
            }
        }
        md += '---\n\n';
    }

    // 4. Dependencies
    if (data.dependencies && data.dependencies.length > 0) {
        md += '## 4. –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\n\n';
        data.dependencies.forEach(dep => {
            md += `### ${escapeHtml(dep.name || '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å')}\n\n`;
            md += `- **–¢–∏–ø:** ${escapeHtml(dep.type || 'external')}\n`;
            md += `- **–û–ø–∏—Å–∞–Ω–∏–µ:** ${escapeHtml(dep.description || '‚Äî')}\n\n`;
        });
        md += '---\n\n';
    }

    // 5. Algorithm
    if (data.algorithm) {
        md += '## 5. –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏\n\n```\n' + escapeHtml(data.algorithm) + '\n```\n\n---\n\n';
    }

    // 6. Mermaid
    if (data.mermaidDiagram) {
        md += '## 6. –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞\n\n```mermaid\n' + escapeHtml(data.mermaidDiagram) + '\n```\n\n---\n\n';
    }

    // 7. Notes
    if (data.notes) {
        md += '## 7. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è\n\n' + escapeHtml(data.notes) + '\n\n';
    }

    return md;
}

function fieldsToMarkdownTable(fields) {
    if (!fields || fields.length === 0) return '(–ü–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)\n\n';
    
    const flat = flattenFields(fields);
    let table = '| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑. | –§–æ—Ä–º–∞—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |\n';
    table += '|------|-----|-------|--------|---------|--------|\n';
    
    flat.forEach(f => {
        const indent = Array(f.depth * 2).fill('&nbsp;').join('');
        const field = indent + escapeHtml(f.name);
        const type = escapeHtml(f.type || '‚Äî');
        const required = f.required ? '‚úì' : '‚úó';
        const format = escapeHtml(f.format || '‚Äî');
        const desc = escapeHtml(f.description || '‚Äî');
        const example = escapeHtml(f.example || '‚Äî');
        table += `| ${field} | ${type} | ${required} | ${format} | ${desc} | ${example} |\n`;
    });
    
    return table + '\n';
}

function saveMarkdownFile(data) {
    const markdown = generateMarkdown(data);
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (data.operationId || 'api-doc') + '.md';
    a.click();
    URL.revokeObjectURL(url);
}

function getUnfilledCount(data) {
    let count = 0;
    
    if (!data.notes || data.notes.trim() === '') {
        count++;
    }
    
    if (!data.algorithm || data.algorithm.trim() === '') {
        count++;
    }
    
    if (!data.mermaidDiagram || data.mermaidDiagram.trim() === '') {
        count++;
    }

    if (!data.dependencies || data.dependencies.length === 0) {
        count++;
    }
    
    return count;
}

function updateUnfilledCount(data) {
    const countEl = document.getElementById('unfilled-count');
    if (countEl) {
        countEl.textContent = getUnfilledCount(data);
    }
}

function renderDependencies(dependencies = []) {
    let html = `<div style="color:var(--text-tertiary);margin-bottom:12px;font-size:12px;">üî¥ –î–æ–±–∞–≤—å—Ç–µ –≤–Ω–µ—à–Ω–∏–µ API –≤—ã–∑–æ–≤—ã.</div><div id="deps-container">`;
    
    if (dependencies && dependencies.length > 0) {
        dependencies.forEach((dep, i) => {
            html += `<div class="dep-card" id="dep-${i}">
                <div class="dep-card-header">
                    <span class="dep-card-title">${escapeHtml(dep.name || '')}</span>
                    <button class="dep-remove-btn" onclick="removeDependency(${i})">‚úï</button>
                </div>
                <div class="kv-grid" style="margin-bottom:12px;">
                    <div class="kv-label">–¢–∏–ø</div>
                    <div class="kv-value cell-required">
                        <input type="text" class="cell-input" value="${escapeHtml(dep.type || 'external')}" onchange="updateDependency(${i}, 'type', this.value)">
                    </div>
                    <div class="kv-label">–ò–º—è</div>
                    <div class="kv-value cell-required">
                        <input type="text" class="cell-input" value="${escapeHtml(dep.name || '')}" onchange="updateDependency(${i}, 'name', this.value)">
                    </div>
                    <div class="kv-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="kv-value cell-required">
                        <textarea class="cell-input" onchange="updateDependency(${i}, 'description', this.value)">${escapeHtml(dep.description || '')}</textarea>
                    </div>
                </div>
            </div>`;
        });
    }

    html += `</div><button class="add-row-btn" onclick="addDependency()">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</button>`;
    return html;
}

function addDependency() {
    if (!currentData) return;
    if (!currentData.dependencies) {
        currentData.dependencies = [];
    }
    currentData.dependencies.push({
        type: 'external',
        name: '–ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å',
        description: ''
    });
    const container = document.getElementById('deps-container');
    if (container) {
        container.parentElement.innerHTML = renderDependencies(currentData.dependencies);
    }
    updateUnfilledCount(currentData);
}

function removeDependency(index) {
    if (!currentData || !currentData.dependencies) return;
    currentData.dependencies.splice(index, 1);
    const container = document.getElementById('deps-container');
    if (container) {
        container.parentElement.innerHTML = renderDependencies(currentData.dependencies);
    }
    updateUnfilledCount(currentData);
}

function updateDependency(index, field, value) {
    if (!currentData || !currentData.dependencies || !currentData.dependencies[index]) return;
    currentData.dependencies[index][field] = value;
    updateUnfilledCount(currentData);
}

function generateExample(fields) {
    if (!fields || fields.length === 0) return null;
    
    const result = {};
    
    fields.forEach(field => {
        if (field.depth === 0) {
            result[field.name] = generateFieldExample(field);
        }
    });
    
    return result;
}

function generateFieldExample(field) {
    if (field.example) {
        return field.example;
    }
    
    const fieldType = (field.type || '').toLowerCase();
    
    switch (fieldType) {
        case 'string':
            if (field.format === 'email') return 'user@example.com';
            if (field.format === 'date') return '2023-12-25';
            if (field.format === 'date-time') return '2023-12-25T10:30:00Z';
            return 'example_value';
            
        case 'integer':
        case 'number':
            return field.format === 'int32' ? 42 : 3.14;
            
        case 'boolean':
            return true;
            
        case 'array':
            return [generateFieldExample({type: 'string'})];
            
        case 'object':
            if (field.children && field.children.length > 0) {
                const obj = {};
                field.children.forEach(child => {
                    obj[child.name] = generateFieldExample(child);
                });
                return obj;
            }
            return {};
            
        default:
            return 'example';
    }
}

function displayParsedData(data) {
    const container = document.getElementById('editor-content');
    const mc = `method-${data.method.toLowerCase()}`;
    
    let html = `
        <!-- 1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è <span class="section-badge badge-auto">‚úì –ê–≤—Ç–æ</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div class="kv-grid">
                    <div class="kv-label">–ú–µ—Ç–æ–¥</div>
                    <div class="kv-value cell-auto">
                        <span class="cell-static"><span class="method-badge ${mc}">${escapeHtml(data.method)}</span></span>
                    </div>
                    <div class="kv-label">URL</div>
                    <div class="kv-value cell-auto">
                        <span class="cell-static">${escapeHtml(data.url || '')}</span>
                    </div>
                    <div class="kv-label">–¢–µ–≥</div>
                    <div class="kv-value cell-auto">
                        <span class="cell-static">${escapeHtml(data.tag || '')}</span>
                    </div>
                    <div class="kv-label">Operation</div>
                    <div class="kv-value cell-auto">
                        <span class="cell-static">${escapeHtml(data.operationId || '')}</span>
                    </div>
                    <div class="kv-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="kv-value ${data.summary ? 'cell-auto' : 'cell-manual'}">
                        <span class="cell-static">${escapeHtml(data.summary || '')}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 2. Request Body
    if (data.requestFields && data.requestFields.length > 0) {
        html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">2. Request Body <span class="section-badge badge-auto">‚úì –ê–≤—Ç–æ</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <p style="margin-bottom:12px;color:var(--text-secondary);">–°—Ö–µ–º–∞: <code style="color:var(--accent-blue);">${escapeHtml(data.requestSchemaName || 'Unknown')}</code></p>
                ${renderFieldsTable(data.requestFields, true)}
            </div>
        </div>

        <!-- 2.1 –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ -->
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">2.1 –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ <span class="section-badge badge-manual">‚úé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div style="color:var(--text-secondary);margin-bottom:12px;font-size:12px;">‚úèÔ∏è –ü—Ä–∏–º–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ DTO. –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ.</div>
                <textarea class="block-editor" data-bind="exampleRequest" placeholder='{"field":"value"}'>${escapeHtml(JSON.stringify(generateExample(data.requestFields), null, 2))}</textarea>
            </div>
        </div>
        `;
    }

    // 3. Response
    html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">3. Response <span class="section-badge badge-auto">‚úì –ê–≤—Ç–æ</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <h4 style="color:var(--accent-green);margin-bottom:8px;">–û—Ç–≤–µ—Ç—ã</h4>
                <div style="text-align:center;padding:12px;color:var(--text-secondary);"><span class="response-code response-2xx">200</span> OK</div>
            </div>
        </div>
    `;

    // 3.1 Response Body
    if (data.responseFields && data.responseFields.length > 0) {
        html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">3.1 Response Body <span class="section-badge badge-auto">‚úì –ê–≤—Ç–æ</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <p style="margin-bottom:12px;color:var(--text-secondary);">–°—Ö–µ–º–∞: <code style="color:var(--accent-blue);">${escapeHtml(data.responseSchemaName || 'response')}</code></p>
                ${renderFieldsTable(data.responseFields)}
            </div>
        </div>

        <!-- 3.2 –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ -->
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">3.2 –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ <span class="section-badge badge-manual">‚úé –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div style="color:var(--text-secondary);margin-bottom:12px;font-size:12px;">‚úèÔ∏è –ü—Ä–∏–º–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ DTO. –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ.</div>
                <textarea class="block-editor" data-bind="exampleResponse" placeholder='{"field":"value"}'>${escapeHtml(JSON.stringify(generateExample(data.responseFields), null, 2))}</textarea>
            </div>
        </div>
        `;
    }

    // 4. Dependencies
    html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">4. –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ <span class="section-badge badge-required">‚ö† –ó–∞–ø–æ–ª–Ω–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                ${renderDependencies(data.dependencies || [])}
            </div>
        </div>
    `;

    // 5. Logic
    html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">5. –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏ <span class="section-badge badge-required">‚ö† –ó–∞–ø–æ–ª–Ω–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div style="color:var(--text-secondary);margin-bottom:12px;font-size:12px;">üî¥ –û–ø–∏—à–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º.</div>
                <textarea class="block-editor" data-bind="algorithm" placeholder="–í–•–û–î: DTO&#10;–®–ê–ì 1: ...&#10;–í–´–•–û–î: 200 OK" style="min-height:200px;">${escapeHtml(data.algorithm || '')}</textarea>
            </div>
        </div>
    `;

    // 6. Mermaid
    html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">6. –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ <span class="section-badge badge-required">‚ö† –ó–∞–ø–æ–ª–Ω–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div style="color:var(--text-secondary);margin-bottom:12px;font-size:12px;">üî¥ –°–æ–∑–¥–∞–π—Ç–µ –±–ª–æ–∫-—Å—Ö–µ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Mermaid.</div>
                <div class="mermaid-editor-container">
                    <div class="mermaid-editor-panel">
                        <div class="mermaid-panel-header">
                            <span class="icon">‚úèÔ∏è</span>
                            <span>–†–µ–¥–∞–∫—Ç–æ—Ä</span>
                        </div>
                        <textarea id="mermaid-code-editor" class="mermaid-code-editor" data-bind="mermaidDiagram" placeholder="graph TD&#10;    Start[–ù–∞—á–∞–ª–æ] --> Input[...]&#10;    Input --> End[–ö–æ–Ω–µ—Ü]" style="min-height:300px;">${escapeHtml(data.mermaidDiagram || '')}</textarea>
                    </div>
                    <div class="mermaid-editor-panel">
                        <div class="mermaid-panel-header">
                            <span class="icon">üëÅÔ∏è</span>
                            <span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </div>
                        <div id="mermaid-preview" class="mermaid-preview-container">
                            <div class="mermaid-preview-empty">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å–ª–µ–≤–∞...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 7. Notes
    html += `
        <div class="template-section">
            <div class="section-header">
                <div class="section-title">7. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è <span class="section-badge badge-required">‚ö† –ó–∞–ø–æ–ª–Ω–∏—Ç—å</span></div>
                <span class="section-chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div style="color:var(--text-secondary);margin-bottom:12px;font-size:12px;">üî¥ –ü—Ä–∏–º–µ—á–∞–Ω–∏—è.</div>
                <textarea class="block-editor" data-bind="notes" placeholder="- Edge cases..." style="min-height:150px;">${escapeHtml(data.notes || '')}</textarea>
            </div>
        </div>
    `;

    container.innerHTML = html;
    
    // Attach handlers
    attachCollapsibleHandlers();
    attachMermaidHandlers();
    attachInputHandlers();
}

function attachInputHandlers() {
    // Listen to changes in textarea/input and update currentData
    document.querySelectorAll('[data-bind]').forEach(input => {
        input.addEventListener('change', () => {
            const path = input.dataset.bind;
            updateDataByPath(currentData, path, input.value);
        });
    });
}

function updateDataByPath(obj, path, value) {
    const keys = path.split('.');
    let current = obj;
    
    for (let i = 0; i < keys.length - 1; i++) {
        const key = keys[i];
        if (!current[key]) {
            current[key] = {};
        }
        current = current[key];
    }
    
    current[keys[keys.length - 1]] = value;
    updateUnfilledCount(currentData);
}

function showPreviewModal(data) {
    if (!data) return;
    
    const markdown = generateMarkdown(data);
    const preview = document.getElementById('preview-content');
    preview.textContent = markdown;
    
    document.getElementById('preview-modal').classList.remove('hidden');
}

function toggleTheme() {
    const root = document.documentElement;
    const currentTheme = root.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light-pink' : 'dark';
    
    if (newTheme === 'light-pink') {
        root.setAttribute('data-theme', 'light-pink');
    } else {
        root.removeAttribute('data-theme');
    }
    
    localStorage.setItem('app-theme', newTheme);
    
    const btn = document.getElementById('theme-toggle');
    if (btn) {
        btn.textContent = newTheme === 'dark' ? 'üå∏' : 'üåô';
    }
}

function attachCollapsibleHandlers() {
    document.querySelectorAll('.section-header').forEach(header => {
        // Remove old listener if exists
        header.removeEventListener('click', toggleSection);
        header.addEventListener('click', toggleSection);
    });
}

function toggleSection(e) {
    const header = e.currentTarget;
    const body = header.nextElementSibling;
    
    header.classList.toggle('collapsed');
    body.classList.toggle('collapsed-body');
}

</script>
</body>
</html>
